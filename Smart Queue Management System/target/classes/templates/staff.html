<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Staff Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#eef6ff; }
    .panel { max-width:900px; margin:30px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
    #waiting li { padding:8px 0; border-bottom:1px solid #f0f0f0; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <label>Branch</label>
        <input id="branch" class="form-control d-inline-block" style="width:160px" value="Main">
      </div>
      <div>
        <label>Counter</label>
        <input id="counter" class="form-control d-inline-block" style="width:160px" value="Counter-1">
      </div>
      <div>
        <button class="btn btn-success" onclick="getNext()">Serve Next</button>
        <a href="/logout" class="btn btn-outline-secondary">Logout</a>
      </div>
    </div>

    <h5>Waiting</h5>
    <ul id="waiting"></ul>

    <!-- audio file -->
    <audio id="ding" src="/sound.mp3"></audio>
  </div>

<script>
async function refresh() {
    const branch = document.getElementById('branch').value;
    const res = await fetch('/api/waiting?branch=' + encodeURIComponent(branch));
    const list = await res.json();
    const ul = document.getElementById('waiting');
    ul.innerHTML = '';
    list.forEach(t => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${t.tokenCode}</strong> — ${t.priorityCategory} ${t.patientName ? ' — ' + t.patientName : ''}`;
        ul.appendChild(li);
    });
}

async function getNext() {
    const branch = document.getElementById('branch').value;
    const counter = document.getElementById('counter').value;

    const res = await fetch('/api/next?branch=' + encodeURIComponent(branch) + '&counter=' + encodeURIComponent(counter), { method: 'POST' });
    if (res.status === 200) {
        const t = await res.json();

        // play sound
        try { document.getElementById('ding').play(); } catch(e) {}

        // voice announcement
        const announcement = `Now serving token ${t.tokenCode} at ${t.counter}`;
        if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(announcement);
            window.speechSynthesis.speak(utter);
        }

        alert('Now serving: ' + t.tokenCode + ' at ' + t.counter);
        refresh();
    } else {
        alert('No one waiting');
    }
}

setInterval(refresh, 3000);
refresh();
</script>
</body>
</html>
